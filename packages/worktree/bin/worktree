#!/usr/bin/env node

const { execFileSync } = require("child_process");
const path = require("path");
const fs = require("fs");

const PLATFORMS = {
  "darwin-arm64": "@skauffmann/worktree-darwin-arm64",
  "darwin-x64": "@skauffmann/worktree-darwin-x64",
  "linux-x64": "@skauffmann/worktree-linux-x64",
  "linux-arm64": "@skauffmann/worktree-linux-arm64",
  "win32-x64": "@skauffmann/worktree-win32-x64",
};

function getBinaryPath() {
  const platformKey = `${process.platform}-${process.arch}`;
  const packageName = PLATFORMS[platformKey];

  if (!packageName) {
    console.error(
      `Unsupported platform: ${platformKey}\n` +
        `Supported platforms: ${Object.keys(PLATFORMS).join(", ")}`
    );
    process.exit(1);
  }

  const binaryName = process.platform === "win32" ? "worktree.exe" : "worktree";

  // Try to resolve from optionalDependencies
  try {
    return require.resolve(`${packageName}/bin/${binaryName}`);
  } catch (e) {
    // Fallback: check if binary was downloaded by postinstall
    const fallbackPath = path.join(__dirname, "..", "bin-fallback", binaryName);
    if (fs.existsSync(fallbackPath)) {
      return fallbackPath;
    }

    console.error(
      `Could not find worktree binary for ${platformKey}.\n` +
        `Package ${packageName} may not be installed.\n` +
        `Try reinstalling: npm install -g @skauffmann/worktree`
    );
    process.exit(1);
  }
}

const binaryPath = getBinaryPath();
const args = process.argv.slice(2);

try {
  const result = execFileSync(binaryPath, args, {
    stdio: "inherit",
    encoding: "utf-8",
  });
} catch (error) {
  if (error.status !== undefined) {
    process.exit(error.status);
  }
  throw error;
}
